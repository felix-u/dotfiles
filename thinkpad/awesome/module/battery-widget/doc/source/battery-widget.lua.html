<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>Awesome WM - Battery Widget</title>
    <link rel="stylesheet" href="../ldoc.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>battery_widget</h1>




<h2>Source</h2>
<ul class="nowrap">
  <li><strong>battery-widget.lua</strong></li>
</ul>
<h2>Modules</h2>
<ul class="nowrap">
  <li><a href="../index.html">battery-widget</a></li>
</ul>

</div>

<div id="content">

    <h2>battery-widget.lua</h2>
<pre>
<span class="comment">---------------------------------------------------------------------------
</span><span class="comment">-- A battery widget based on the UPower deamon.
</span><span class="comment">--
</span><span class="comment">-- @author Aire-One
</span><span class="comment">-- @copyright 2020 Aire-One
</span><span class="comment">---------------------------------------------------------------------------
</span>
<span class="keyword">local</span> upower = <span class="global">require</span>(<span class="string">'lgi'</span>).<span class="global">require</span>(<span class="string">'UPowerGlib'</span>)

<span class="keyword">local</span> gtable = <span class="global">require</span> <span class="string">'gears.table'</span>
<span class="keyword">local</span> gtimer = <span class="global">require</span> <span class="string">'gears.timer'</span>
<span class="keyword">local</span> wbase = <span class="global">require</span> <span class="string">'wibox.widget.base'</span>

<span class="keyword">local</span> <span class="global">setmetatable</span> = <span class="global">setmetatable</span> <span class="comment">-- luacheck: ignore setmetatable
</span><span class="keyword">local</span> screen = screen <span class="comment">-- luacheck: ignore screen
</span>

<span class="keyword">local</span> battery_widget = {}
<span class="keyword">local</span> mt = {}


<span class="comment">--- Helper to get the path of all connected power devices.
</span><span class="comment">-- @treturn table The list of all power devices path.
</span><a id="25"></a><span class="comment">-- @staticfct battery_widget.list_devices
</span><span class="keyword">function</span> battery_widget.list_devices()
    <span class="keyword">local</span> ret = {}
    <span class="keyword">local</span> devices = upower.Client():get_devices()

    <span class="keyword">for</span> _,d <span class="keyword">in</span> <span class="global">ipairs</span>(devices) <span class="keyword">do</span>
        <span class="global">table</span>.insert(ret, d:get_object_path())
    <span class="keyword">end</span>

    <span class="keyword">return</span> ret
<span class="keyword">end</span>

<span class="comment">--- Helper function to get a device instance from its path.
</span><span class="comment">-- @tparam string path The path of the device to get.
</span><span class="comment">-- @treturn UPowerGlib.Device|nil The device if it was found, <code>nil</code> otherwise.
</span><a id="40"></a><span class="comment">-- @staticfct battery_widget.get_device
</span><span class="keyword">function</span> battery_widget.get_device(path)
    <span class="keyword">local</span> devices = upower.Client():get_devices()

    <span class="keyword">for</span> _,d <span class="keyword">in</span> <span class="global">ipairs</span>(devices) <span class="keyword">do</span>
        <span class="keyword">if</span> d:get_object_path() == path <span class="keyword">then</span>
            <span class="keyword">return</span> d
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="keyword">return</span> <span class="keyword">nil</span>
<span class="keyword">end</span>

<span class="comment">--- Helper function to easily get the default BAT0 device path without.
</span><span class="comment">-- @treturn string The BAT0 device path.
</span><a id="55"></a><span class="comment">-- @staticfct battery_widget.get_BAT0_device_path
</span><span class="keyword">function</span> battery_widget.get_BAT0_device_path()
    <span class="keyword">local</span> bat0_path = <span class="string">'/org/freedesktop/UPower/devices/battery_BAT0'</span>
    <span class="keyword">return</span> bat0_path
<span class="keyword">end</span>

<span class="comment">--- Helper function to convert seconds into a human readable clock string.
</span><span class="comment">--
</span><span class="comment">-- This translates the given seconds parameter into a human readable string
</span><span class="comment">-- following the notation <code>HH:MM</code> (where HH is the number of hours and MM the
</span><span class="comment">-- number of minutes).
</span><span class="comment">-- @tparam number seconds The umber of seconds to translate.
</span><span class="comment">-- @treturn string The human readable generated clock string.
</span><a id="68"></a><span class="comment">-- @staticfct battery_widget.to_clock
</span><span class="keyword">function</span> battery_widget.to_clock(seconds)
    <span class="keyword">if</span> seconds &lt;= <span class="number">0</span> <span class="keyword">then</span>
        <span class="keyword">return</span> <span class="string">'00:00'</span>;
    <span class="keyword">else</span>
        <span class="keyword">local</span> hours = <span class="global">string</span>.format(<span class="string">'%02.f'</span>, <span class="global">math</span>.floor(seconds/<span class="number">3600</span>));
        <span class="keyword">local</span> mins = <span class="global">string</span>.format(<span class="string">'%02.f'</span>, <span class="global">math</span>.floor(seconds/<span class="number">60</span> - hours*<span class="number">60</span>));
        <span class="keyword">return</span> hours .. <span class="string">':'</span> .. mins
    <span class="keyword">end</span>
<span class="keyword">end</span>


<span class="comment">--- Gives the default widget to use if user didn't specify one.
</span><span class="comment">-- The default widget used is an <code>empty_widget</code> instance.
</span><span class="comment">-- @treturn widget The default widget to use.
</span><span class="keyword">local</span> <span class="keyword">function</span> default_template ()
    <span class="keyword">return</span> wbase.empty_widget()
<span class="keyword">end</span>


<span class="comment">--- The device monitored by the widget.
</span><span class="comment">-- @property device
</span><span class="comment">-- @tparam UPowerGlib.Device device
</span><a id="91"></a>
<span class="comment">--- Emited when the UPower device notify an update.
</span><span class="comment">-- @signal upower::update
</span><span class="comment">-- @tparam battery_widget widget The widget.
</span><span class="comment">-- @tparam UPowerGlib.Device device The Upower device.
</span><a id="97"></a>

<span class="comment">--- battery_widget constructor.
</span><span class="comment">--
</span><span class="comment">-- This function creates a new <code>battery_widget</code> instance. This widget watches
</span><span class="comment">-- the <code>display_device</code> status and report.
</span><span class="comment">-- @tparam table args The arguments table.
</span><span class="comment">-- @tparam[opt=1] screen|number args.screen the widget's screen.
</span><span class="comment">-- @tparam[opt] widget args.widget_template The widget template to use to
</span><span class="comment">--   create the widget instance.
</span><span class="comment">-- @tparam[opt] function args.create_callback User defined callback for the
</span><span class="comment">--   widget initialization.
</span><span class="comment">-- @tparam[opt] string args.device_path Path of the device to monitor.
</span><span class="comment">-- @tparam[opt=false] boolean args.use_display_device Should the widget monitor
</span><span class="comment">--   the _display device_?
</span><span class="comment">-- @tparam[opt] boolean args.instant_update Call an update cycle right after the
</span><span class="comment">--   widget creation.
</span><span class="comment">-- @treturn battery_widget The battery_widget instance build.
</span><a id="114"></a><span class="comment">-- @constructorfct battery_widget.new
</span><span class="keyword">function</span> battery_widget.new (args)
    args = gtable.crush({
        widget_template = default_template(),
        create_callback = <span class="keyword">nil</span>,
        device_path = <span class="string">''</span>,
        use_display_device = <span class="keyword">false</span>
    }, args <span class="keyword">or</span> {})
    args.screen = screen[args.screen <span class="keyword">or</span> <span class="number">1</span>]

    <span class="keyword">local</span> widget = wbase.make_widget_from_value(args.widget_template)

    widget.device = args.use_display_device
        <span class="keyword">and</span> upower.Client():get_display_device()
        <span class="keyword">or</span> battery_widget.get_device(args.device_path)

    <span class="keyword">if</span> <span class="global">type</span>(args.create_callback) == <span class="string">'function'</span> <span class="keyword">then</span>
        args.create_callback(widget, widget.device)
    <span class="keyword">end</span>

    <span class="comment">-- Attach signals:
</span>    widget.device.on_notify = <span class="keyword">function</span> (d)
        widget:emit_signal(<span class="string">'upower::update'</span>, d)
    <span class="keyword">end</span>

    <span class="comment">-- Call an update cycle if the user asked to instan update the widget.
</span>    <span class="keyword">if</span> args.instant_update <span class="keyword">then</span>
        gtimer.delayed_call(widget.emit_signal, widget, <span class="string">'upower::update'</span>, widget.device)
    <span class="keyword">end</span>

    <span class="keyword">return</span> widget
<span class="keyword">end</span>


<span class="keyword">function</span> mt.__call(self, ...)
    <span class="keyword">return</span> battery_widget.new(...)
<span class="keyword">end</span>

<span class="keyword">return</span> <span class="global">setmetatable</span>(battery_widget, mt)</pre>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.6</a></i>
<i style="float:right;">Last updated 2021-08-15 13:29:09 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
